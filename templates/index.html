{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

<!-- === Dashboard Guide Panel === -->
<div id="dashboardGuide" style="margin-bottom:30px; border:1px solid #ccc; border-radius:8px; padding:15px;">
  <button type="button" id="toggleGuide"
          style="background:#007bff;color:white;border:none;padding:8px 14px;border-radius:5px;cursor:pointer;">
    ‚ÑπÔ∏è Show Dashboard Guide
  </button>

  <div id="guideContent" style="display:none;margin-top:15px;">
    <h2>üìä Dashboard Overview</h2>
    <p>
      This dashboard lets you <b>analyze and compare up to two stocks</b> using live or uploaded data.
      You can apply <b>technical indicators</b>, choose <b>time ranges</b>, and view <b>sentiment-based news</b>.
    </p>
    <h3>üß© 1. Stock Inputs</h3>
    <ul>
      <li><b>Stock Ticker 1</b> ‚Äî required (e.g. NVDA).</li>
      <li><b>Ticker 2</b> ‚Äî optional comparison (e.g. MSFT).</li>
      <li><b>CSV Upload</b> ‚Äî use your own dataset for offline analysis.</li>
      <li>Use ‚ÄúRemove File‚Äù to clear an upload.</li>
    </ul>
    <h3>‚è± 2. Timeframe</h3>
    <p>Filter data to <b>1M ¬∑ 3M ¬∑ 6M ¬∑ 1Y ¬∑ 2Y</b>.</p>
    <h3>üìà 3. Indicator Options</h3>
    <table style="width:100%;border-collapse:collapse;">
      <tr><th style="border-bottom:1px solid #ddd;">Indicator</th><th style="border-bottom:1px solid #ddd;">Purpose</th></tr>
      <tr><td>Close Prices</td><td>Closing values over time.</td></tr>
      <tr><td>SMA</td><td>Simple Moving Average for trend direction.</td></tr>
      <tr><td>EMA</td><td>Exponential Moving Average (more reactive).</td></tr>
      <tr><td>RSI</td><td>Overbought/oversold signal.</td></tr>
      <tr><td>MACD</td><td>Momentum divergence.</td></tr>
      <tr><td>Daily Returns</td><td>Percent change between days.</td></tr>
    </table>
    <h3>‚öôÔ∏è 4. Parameters</h3><p>Edit indicator settings (e.g. SMA period).</p>
    <h3>üßº 5. Preprocessing</h3><p>Enable to preview cleaned data.</p>
    <h3>üíπ 6. Analysis Results</h3><p>Graph visualizes indicators for both datasets.</p>
    <h3>üì∞ 7. News & Sentiment</h3><p>Latest financial news with sentiment analysis.</p>
    <h3>üîÅ 8. Auto Refresh</h3><p>Updates prices (30 s) and news (3 min).</p>
  </div>
</div>

<script>
document.getElementById("toggleGuide").addEventListener("click",()=>{
  const c=document.getElementById("guideContent");
  const b=document.getElementById("toggleGuide");
  const show=c.style.display==="none";
  c.style.display=show?"block":"none";
  b.textContent=show?"‚ùå Hide Dashboard Guide":"‚ÑπÔ∏è Show Dashboard Guide";
});
</script>

<!-- === Highlight Styles for Active Selections === -->
<style>
.tab {
  border: 1px solid #ccc;
  background: #f9f9f9;
  color: #333;
  padding: 6px 12px;
  border-radius: 5px;
  margin-right: 4px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
.tab:hover { background: #eaeaea; }
.tab.active-time { background: #007bff; color: white; transform: scale(1.05); }
.tab.active-ind { background: #28a745; color: white; transform: scale(1.05); }
</style>

<!-- === Main Dashboard Form === -->
<form method="POST" enctype="multipart/form-data">
  <input type="hidden" name="time_range" id="time_range_input" value="{{ time_range or '1Y' }}">
  <input type="hidden" name="indicator" id="indicator_input" value="{{ shown_indicator or indicator or 'close' }}">

  <label for="ticker1">Enter Stock Ticker 1:</label>
  <input type="text" name="ticker1" id="ticker1" placeholder="AAPL" value="{{request.form.ticker1 or ''}}">
  <label for="ticker2">Enter Ticker 2 (optional):</label>
  <input type="text" name="ticker2" id="ticker2" placeholder="MSFT" value="{{request.form.ticker2 or ''}}">

  <p>Upload CSV/XLSX/JSON (optional):</p>
  <input type="file" name="file1" accept=".csv,.xlsx,.json">
  <label>{% if labels %}{{labels[0]}}{% endif %}</label>
  <button type="submit" name="remove_file" value="remove_file1">Remove File 1</button>

  <p>Upload second CSV (optional):</p>
  <input type="file" name="file2" accept=".csv,.xlsx,.json">
  <label>{% if labels %}{{labels[1]}}{% endif %}</label>
  <button type="submit" name="remove_file" value="remove_file2">Remove File 2</button>

  <p>Select timeframe:</p>
  <div class="tabs" style="margin-top: 12px;">
    <button type="button" class="tab {% if time_range=='1M' %}active{% endif %}" data-value="1M">1 Month</button>
    <button type="button" class="tab {% if time_range=='3M' %}active{% endif %}" data-value="3M">3 Months</button>
    <button type="button" class="tab {% if time_range=='6M' %}active{% endif %}" data-value="6M">6 Months</button>
    <button type="button" class="tab {% if time_range=='1Y' or not time_range %}active{% endif %}" data-value="1Y">1 Year</button>
    <button type="button" class="tab {% if time_range=='2Y' %}active{% endif %}" data-value="2Y">2 Years</button>
  </div>

  <p>Select indicator:</p>
  <div class="tabs" style="margin-top: 12px;">
    <button type="button" class="tab {% if shown_indicator=='close' or not shown_indicator %}active{% endif %}" data-value="close">Close Prices</button>
    <button type="button" class="tab {% if shown_indicator=='sma' %}active{% endif %}" data-value="sma">SMA</button>
    <button type="button" class="tab {% if shown_indicator=='ema' %}active{% endif %}" data-value="ema">EMA</button>
    <button type="button" class="tab {% if shown_indicator=='rsi' %}active{% endif %}" data-value="rsi">RSI</button>
    <button type="button" class="tab {% if shown_indicator=='macd' %}active{% endif %}" data-value="macd">MACD</button>
    <button type="button" class="tab {% if shown_indicator=='dailyr' %}active{% endif %}" data-value="dailyr">Daily Returns</button>
  </div>

  {% if shown_indicator %}
    <div id="editable-params" style="margin-top:12px;">
      <h3>{{ shown_indicator|upper }} Parameters</h3>
      {% if params %}
        {% for key, value in params.items() %}
        <div class="param-field">
          <label for="{{ key }}">{{ key }}:</label>
          {% if value is number %}
            <input type="number" id="{{shown_indicator}}_{{ key }}" name="{{shown_indicator}}_{{ key }}" value="{{ value }}" class="param-input">
          {% elif value is string %}
            <input type="text" id="{{shown_indicator}}_{{ key }}" name="{{shown_indicator}}_{{ key }}" value="{{ value }}" class="param-input">
          {% elif value is boolean %}
            <select id="{{shown_indicator}}_{{ key }}" name="{{shown_indicator}}_{{ key }}" class="param-select">
              <option value="true" {% if value %}selected{% endif %}>True</option>
              <option value="false" {% if not value %}selected{% endif %}>False</option>
            </select>
          {% else %}
            <input type="text" id="{{shown_indicator}}_{{ key }}" name="{{shown_indicator}}_{{ key }}" value="{{ value }}" class="param-input">
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <p>No parameter metadata for this indicator ‚Äî defaults will be used.</p>
      {% endif %}
    </div>

  <!-- Update + Clear Buttons -->
  <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-start;">
    <button id="clearSessionBtn" type="button"
            style="flex:1;max-width:160px;background:#dc3545;color:white;border:none;
                   padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">
      üßπ Clear Saved Session
    </button>
  </div>
  {% endif %}

  <!-- Manual Run -->
  <div style="margin-top:12px;">
    <button id="runAnalysisBtn" type="submit"
            style="background:#28a745;color:white;border:none;padding:16px 22px;
                   border-radius:5px;cursor:pointer;font-size:0.95em;">
      Submit
    </button>
  </div>

  <div style="margin-top:15px;">
    <label><input type="checkbox" name="show_preprocessed" value="1"
      {% if show_preprocessed %}checked{% endif %}> Show preprocessed data preview</label>
  </div>
</form>

{% if error %}<p style="color:red">{{error}}</p>{% endif %}

{% if summaries %}
<div class="stock-summary-container">
{% for s in summaries %}
  <div class="stock-summary-card">
    <div class="stock-left">
      {% if s.logo %}<img src="{{s.logo}}" alt="{{s.symbol}} logo" class="stock-logo">{% endif %}
      <div><h3>{{s.name}}</h3><p>{{s.symbol}}</p></div>
    </div>
    <div class="stock-right">
      {% if s.price %}
      <h3 class="stock-price" data-symbol="{{s.symbol}}">${{"%.2f"|format(s.price)}}</h3>
      <small class="last-updated" data-symbol="{{s.symbol}}" style="color:#888;">Last updated: ‚Äî</small>
      {% endif %}
      {% if s.change %}
      <span class="change {% if s.change>=0 %}pos{% else %}neg{% endif %}">
        {{"%+.2f"|format(s.change)}} ({{"%+.2f"|format(s.pct)}}%)
      </span>
      {% endif %}
    </div>
  </div>
{% endfor %}
</div>
{% endif %}

{% if plot_div %}
<div id="plot-area" style="margin-top:20px;">
  <h2>Analysis Results {% if shown_indicator %}- {{shown_indicator|upper}}{% endif %}</h2>
  <ul>{% for label in labels %}<li>{{label}}</li>{% endfor %}</ul>
  <div id="plot-container">{{plot_div|safe}}</div>
</div>
{% endif %}

{% if streak_info and shown_indicator == 'dailyr' %}
<div class="card mt-4 p-3">
  <h4 class="mb-3">Streak Summary</h4>
    <div class="row">
      <div class="col-md-6">
        <h5 class="text-success">Max Upward Streak</h5>
        {% if streak_info.up_streak %}
          <p><strong>Start Date:</strong> {{ streak_info.up_start }}</p>
          <p><strong>End Date:</strong> {{ streak_info.up_end }}</p>
          <p><strong>Length:</strong> {{ streak_info.up_streak }} trading days</p>
        {% else %}
          <p>No upward streaks found.</p>
        {% endif %}
      </div>

      <div class="col-md-6">
        <h5 class="text-success">Max Downward Streak</h5>
        {% if streak_info.down_streak %}
          <p><strong>Start Date:</strong> {{ streak_info.down_start }}</p>
          <p><strong>End Date:</strong> {{ streak_info.down_end }}</p>
          <p><strong>Length:</strong> {{ streak_info.down_streak }} trading days</p>
        {% else %}
          <p>No upward streaks found.</p>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p>No data to display yet.</p>
</div>
{% endif %}


{% if preprocessed_html %}
<h3 style="margin-top:30px;">üß© Preprocessed Data Preview</h3>
<div class="scroll-container">{{preprocessed_html|safe}}</div>
{% endif %}

<!-- === Selection (local only) === -->
<script>
(function(){
  const form=document.querySelector("form");
  const timeBtns=document.querySelectorAll("button[name='time_range']");
  const indBtns=document.querySelectorAll("button[name='indicator']");
  const timeInput=document.createElement("input");
  timeInput.type="hidden";timeInput.name="time_range";form.appendChild(timeInput);
  const indInput=document.createElement("input");
  indInput.type="hidden";indInput.name="indicator";form.appendChild(indInput);

  const saved=JSON.parse(localStorage.getItem("stock_dashboard_session")||"{}");
  if(saved.time_range){timeBtns.forEach(b=>{if(b.value===saved.time_range)b.classList.add("active-time");});timeInput.value=saved.time_range;}
  if(saved.indicator){indBtns.forEach(b=>{if(b.value===saved.indicator)b.classList.add("active-ind");});indInput.value=saved.indicator;}

  function saveLocal(){
    const sessionData={
      ticker1:document.getElementById("ticker1").value.trim(),
      ticker2:document.getElementById("ticker2").value.trim(),
      time_range:timeInput.value,
      indicator:indInput.value,
      show_preprocessed:document.querySelector("input[name='show_preprocessed']")?.checked||false
    };
    localStorage.setItem("stock_dashboard_session",JSON.stringify(sessionData));
  }

  timeBtns.forEach(btn=>{
    btn.addEventListener("click",()=>{
      timeBtns.forEach(b=>b.classList.remove("active-time"));
      btn.classList.add("active-time");
      timeInput.value=btn.value;
      saveLocal();
    });
  });
  indBtns.forEach(btn=>{
    btn.addEventListener("click",()=>{
      indBtns.forEach(b=>b.classList.remove("active-ind"));
      btn.classList.add("active-ind");
      indInput.value=btn.value;
      saveLocal();
    });
  });
})();
</script>

<!-- === Run Analysis === -->
<script>
document.getElementById("runAnalysisBtn")?.addEventListener("click",()=>{
  const sessionData={
    ticker1:document.getElementById("ticker1").value.trim(),
    ticker2:document.getElementById("ticker2").value.trim(),
    time_range:document.querySelector(".active-time")?.value || "1Y",
    indicator:document.querySelector(".active-ind")?.value || "close",
    show_preprocessed:document.querySelector("input[name='show_preprocessed']")?.checked||false
  };
  localStorage.setItem("stock_dashboard_session",JSON.stringify(sessionData));
  fetch("/save_session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(sessionData)});
});
</script>

<!-- === Auto Refresh + News === -->
<script>
(function(){
  const ticker="{{(labels and labels[-1]) or ''}}";
  if(!ticker)return;
  const plotArea=document.getElementById("plot-area");
  const btn=document.createElement("button");
  btn.id="autoRefreshToggle";btn.textContent="Auto Refresh Off";
  btn.style="margin-top:10px;padding:6px 10px;";
  if(plotArea)plotArea.appendChild(btn);

  let isOn=false,priceInt=null,newsInt=null,lastPrice=null;

  function updatePrice(){
    fetch(`/auto_refresh?ticker=${ticker}`).then(r=>r.json()).then(d=>{
      if(!d||!d.price)return;
      const el=document.querySelector(`.stock-price[data-symbol='${ticker}']`);
      const ts=document.querySelector(`.last-updated[data-symbol='${ticker}']`);
      if(!el)return;
      const newP=Number(d.price);
      el.textContent=`$${newP.toFixed(2)}`;
      if(lastPrice!==null){
        const diff=newP-lastPrice;
        el.style.transition="color 0.5s";
        el.style.color=diff>0?"green":diff<0?"red":"black";
        setTimeout(()=>el.style.color="black",1500);
      }
      if(ts)ts.textContent=`Last updated: ${new Date().toLocaleTimeString()}`;
      lastPrice=newP;
    }).catch(()=>{});
  }

  async function loadNews(auto=false){
    try{
      const res=await fetch(`/get_news?ticker=${ticker}`);
      const data=await res.json();
      const c=document.getElementById("newsContainer");if(!c)return;
      c.innerHTML="";
      if(data.error){c.innerHTML=`<p style='color:red;'>${data.error}</p>`;return;}
      if(!data.articles||!data.articles.length){c.innerHTML=`<p>No recent news for ${ticker}.</p>`;return;}
      let avg=0;
      data.articles.forEach(a=>{
        const s=a.sentiment||0;avg+=s;
        const col=s>0.2?"green":s<-0.2?"red":"#666";
        c.innerHTML+=`<div style='padding:8px 0;border-bottom:1px solid #ddd;'>
          <a href='${a.url}' target='_blank' style='font-weight:600;'>${a.title}</a>
          <div style='color:#888;font-size:0.9em;'>${a.source||"Unknown"} ‚Ä¢ ${a.publishedAt?new Date(a.publishedAt).toLocaleString():""}</div>
          <div>${a.description||""}</div>
          <div style='margin-top:4px;color:${col};'>Sentiment: ${s.toFixed(2)}</div></div>`;
      });
      avg/=data.articles.length;
      const mood=avg>0.2?"Positive":avg<-0.2?"Negative":"Neutral";
      c.insertAdjacentHTML("afterbegin",`<p><b>Overall sentiment:</b> ${mood} ${auto?"(auto-updated)":""}</p>`);
    }catch(e){console.error("News load error:",e);}
  }

  btn.addEventListener("click",()=>{
    if(isOn){clearInterval(priceInt);clearInterval(newsInt);btn.textContent="Auto Refresh Off";}
    else{updatePrice();loadNews(true);
      priceInt=setInterval(updatePrice,30000);
      newsInt=setInterval(()=>loadNews(true),180000);
      btn.textContent="Auto Refresh On";}
    isOn=!isOn;
  });
  loadNews();
})();
</script>

<!-- === News Section === -->
<div id="newsSection" style="margin-top:30px;">
  <h3>üì∞ Latest News</h3>
  <div id="newsContainer" style="margin-top:8px;"><p style="color:#666;">No news loaded yet.</p></div>
</div>

<!-- === Clear Session Handler === -->
<script>
document.getElementById("clearSessionBtn")?.addEventListener("click",()=>{
  localStorage.removeItem("stock_dashboard_session");
  alert("‚úÖ Saved session cleared!");
  fetch("/clear_session",{method:"POST"});
});
</script>

{% endblock %}
